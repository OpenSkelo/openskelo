name: nora-notify

on:
  pull_request_review:
    types: [submitted]
  workflow_run:
    workflows: ["ci", "ai-review", "autofix", "review-dialogue"]
    types: [completed]

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: nora-notify-${{ github.event_name }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  notify-review-changes-requested:
    name: notify-review-changes-requested
    timeout-minutes: 5
    if: >-
      ${{
        github.event_name == 'pull_request_review' &&
        github.event.review.state == 'changes_requested' &&
        github.event.pull_request.base.ref != 'main'
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Send webhook to Nora
        env:
          WEBHOOK_URL: ${{ secrets.NORA_WEBHOOK_URL }}
          WEBHOOK_TOKEN: ${{ secrets.NORA_WEBHOOK_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
          REVIEWER: ${{ github.event.review.user.login }}
          REVIEW_BODY: ${{ github.event.review.body }}
          ACTOR: ${{ github.actor }}
        run: |
          set -euo pipefail
          if [ -z "${WEBHOOK_URL:-}" ] || [ -z "${WEBHOOK_TOKEN:-}" ]; then
            echo "NORA_WEBHOOK_URL or NORA_WEBHOOK_TOKEN is not set; skipping."
            exit 0
          fi

          payload=$(jq -n \
            --arg event "review_changes_requested" \
            --arg repo "$REPO" \
            --arg pr_number "$PR_NUMBER" \
            --arg pr_url "$PR_URL" \
            --arg base "$BASE_REF" \
            --arg head "$HEAD_REF" \
            --arg reviewer "$REVIEWER" \
            --arg review_body "$REVIEW_BODY" \
            --arg actor "$ACTOR" \
            '{event:$event,repo:$repo,pr_number:($pr_number|tonumber),pr_url:$pr_url,base:$base,head:$head,reviewer:$reviewer,review_body:($review_body[0:4000]),actor:$actor}')

          http_code=$(curl --silent --output /tmp/nora_notify_resp.txt --write-out "%{http_code}" \
            --max-time 20 \
            --retry 2 --retry-delay 2 --retry-connrefused \
            -X POST "$WEBHOOK_URL" \
            -H "Authorization: Bearer $WEBHOOK_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$payload")

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "Webhook sent successfully (review_changes_requested)."
          else
            echo "::error::Webhook failed (HTTP $http_code)"
            cat /tmp/nora_notify_resp.txt || true
            exit 1
          fi

  notify-workflow-failure:
    name: notify-workflow-failure
    timeout-minutes: 5
    if: >-
      ${{
        github.event_name == 'workflow_run' &&
        github.event.workflow_run.conclusion == 'failure' &&
        github.event.workflow_run.event == 'pull_request'
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Send webhook to Nora
        env:
          WEBHOOK_URL: ${{ secrets.NORA_WEBHOOK_URL }}
          WEBHOOK_TOKEN: ${{ secrets.NORA_WEBHOOK_TOKEN }}
          REPO: ${{ github.repository }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${WEBHOOK_URL:-}" ] || [ -z "${WEBHOOK_TOKEN:-}" ]; then
            echo "NORA_WEBHOOK_URL or NORA_WEBHOOK_TOKEN is not set; skipping."
            exit 0
          fi

          pr_number=$(curl --silent --show-error \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/commits/$HEAD_SHA/pulls" \
            | jq -r '.[0].number // empty')

          payload=$(jq -n \
            --arg event "workflow_failure" \
            --arg repo "$REPO" \
            --arg workflow "$WORKFLOW_NAME" \
            --arg run_id "$RUN_ID" \
            --arg run_url "$RUN_URL" \
            --arg head_branch "$HEAD_BRANCH" \
            --arg head_sha "$HEAD_SHA" \
            --arg conclusion "$CONCLUSION" \
            --arg actor "$ACTOR" \
            --arg pr_number "$pr_number" \
            '{event:$event,repo:$repo,workflow:$workflow,run_id:($run_id|tonumber),run_url:$run_url,head_branch:$head_branch,head_sha:$head_sha,conclusion:$conclusion,actor:$actor,pr_number:(if $pr_number == "" then null else ($pr_number|tonumber) end)}')

          http_code=$(curl --silent --output /tmp/nora_notify_resp.txt --write-out "%{http_code}" \
            --max-time 20 \
            --retry 2 --retry-delay 2 --retry-connrefused \
            -X POST "$WEBHOOK_URL" \
            -H "Authorization: Bearer $WEBHOOK_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$payload")

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "Webhook sent successfully (workflow_failure)."
          else
            echo "::error::Webhook failed (HTTP $http_code)"
            cat /tmp/nora_notify_resp.txt || true
            exit 1
          fi
