# Content pipeline — linear flow: outline → draft → edit → publish
# For image generation, see content-pipeline-hybrid.yaml
name: content-pipeline

blocks:
  - id: outline
    name: Create Outline
    inputs:
      topic:
        type: string
        description: "Content topic"
      audience:
        type: string
        description: "Target audience"
        required: false
        default: "general"
      format:
        type: string
        description: "Output format (blog, docs, newsletter)"
        required: false
        default: "blog"
    outputs:
      outline:
        type: json
        description: "Structured outline with sections"
      tone:
        type: string
        description: "Recommended tone/style"
    agent:
      role: manager
    pre_gates:
      - name: has-topic
        check: { type: port_not_empty, port: topic }
        error: "Topic is required"
    post_gates: []
    retry: { max_attempts: 1, backoff: none, delay_ms: 0 }

  - id: draft
    name: Write Draft
    inputs:
      outline:
        type: json
        description: "Content outline"
      tone:
        type: string
        description: "Writing tone"
    outputs:
      draft:
        type: string
        description: "Full draft content in markdown"
      word_count:
        type: number
        description: "Word count"
    agent:
      role: worker
      capability: writing
    pre_gates: []
    post_gates:
      - name: min-length
        check: { type: port_min_length, port: draft, min: 500 }
        error: "Draft must be at least 500 characters"
    retry: { max_attempts: 1, backoff: none, delay_ms: 0 }

  - id: edit
    name: Edit & Polish
    inputs:
      draft:
        type: string
        description: "Draft to edit"
    outputs:
      final_markdown:
        type: string
        description: "Edited final content in markdown"
      changelog:
        type: string
        description: "Summary of edits made"
    agent:
      role: reviewer
      capability: writing
    pre_gates: []
    post_gates:
      - name: has-content
        check: { type: port_not_empty, port: final_markdown }
        error: "Editor must produce final content"
    retry: { max_attempts: 0, backoff: none, delay_ms: 0 }

  - id: publish
    mode: deterministic
    name: Save to File
    inputs:
      final_markdown:
        type: string
        description: "Final content to write to disk"
    outputs:
      desktop_file_path:
        type: string
        description: "Absolute path to written file"
      desktop_file_name:
        type: string
        description: "Filename"
      bytes_written:
        type: number
        description: "Bytes written"
      save_summary:
        type: string
        description: "Write result summary"
      final_markdown:
        type: string
        description: "Markdown that was written"
    deterministic:
      handler: builtin:write-file
      config:
        content_from: final_markdown
        default_path_template: "./output/content-{timestamp}.md"
        timestamp_format: "YYYYMMDD-HHmmss"
        mkdir: true
        overwrite: false
    pre_gates:
      - name: has-content
        check: { type: port_not_empty, port: final_markdown }
        error: "Cannot publish empty content"
    post_gates:
      - name: has-output-path
        check: { type: port_matches, port: desktop_file_path, pattern: "content-[0-9]{8}-[0-9]{6}\\.md$" }
        error: "Must save markdown with content-YYYYMMDD-HHMMSS.md filename"
    retry: { max_attempts: 0, backoff: none, delay_ms: 0 }

edges:
  - { from: outline, output: outline, to: draft, input: outline }
  - { from: outline, output: tone, to: draft, input: tone }
  - { from: draft, output: draft, to: edit, input: draft }
  - { from: edit, output: final_markdown, to: publish, input: final_markdown }
